#!groovy

// Required: https://plugins.jenkins.io/pipeline-utility-steps

node {
  def nodes = nodesByLabel label:"blender"
  def nodesSorted = nodes.sort().toList()
  def nodeTasks = [:]
  def nodeCount = nodesSorted.size()
  for (int i = 0; i < nodeCount; ++i) {
    def nodeName = nodesSorted[i]

    nodeTasks[nodeName] = {
      node(nodeName) {
        stage(nodeName) {
          checkout scm
          echo "I am node ${i} of ${nodeCount}"
          sh 'env | sort'
          sh './work.sh'
        }
      }
    }
  }

  parallel nodeTasks
}
