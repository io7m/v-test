#!groovy

// Required: https://plugins.jenkins.io/pipeline-utility-steps

node {
  def nodes = nodesByLabel label:"blender"
  def nodesSorted = nodes.sort().toList()

  def tasks = [:]

  for (int i = 0; i < nodesSorted.size(); ++i) {
    def nodeName = nodesSorted[i]

    tasks[nodeName] = {
      node(nodeName) {
        stage(nodeName) {
          sh 'env | sort'
          sh '${WORKSPACE}/work.sh'
        }
      }
    }
  }

  parallel tasks
}

